(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function n(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(s){if(s.ep)return;s.ep=!0;const r=n(s);fetch(s.href,r)}})();var I;(function(t){t[t.UsbCdcAcm=0]="UsbCdcAcm"})(I||(I={}));const q=32,j=34,V=35,T=255,F=8,z="none",W=1,H=[16,8,7,6,5],K=[1,2],Y=["none","even","odd"],Q=["none","odd","even"],Z=[1,1.5,2],O={protocol:I.UsbCdcAcm,usbControlInterfaceClass:2,usbTransferInterfaceClass:10};function B(t,e){const n=t.configurations[0];for(const i of n.interfaces)if(i.alternates[0].interfaceClass===e)return i;throw new TypeError(`Unable to find interface with class ${e}.`)}function L(t,e){const n=t.alternates[0];for(const i of n.endpoints)if(i.direction==e)return i;throw new TypeError(`Interface ${t.interfaceNumber} does not have an ${e} endpoint.`)}class G{constructor(e,n,i){this.type="bytes",this.device_=e,this.endpoint_=n,this.onError_=i}pull(e){(async()=>{var n;let i;if(e.desiredSize){const s=e.desiredSize/this.endpoint_.packetSize;i=Math.ceil(s)*this.endpoint_.packetSize}else i=this.endpoint_.packetSize;try{const s=await this.device_.transferIn(this.endpoint_.endpointNumber,i);if(s.status!="ok"&&(e.error(`USB error: ${s.status}`),this.onError_()),!((n=s.data)===null||n===void 0)&&n.buffer){const r=new Uint8Array(s.data.buffer,s.data.byteOffset,s.data.byteLength);e.enqueue(r)}}catch(s){e.error(s.toString()),this.onError_()}})()}}class J{constructor(e,n,i){this.device_=e,this.endpoint_=n,this.onError_=i}async write(e,n){try{const i=await this.device_.transferOut(this.endpoint_.endpointNumber,e);i.status!="ok"&&(n.error(i.status),this.onError_())}catch(i){n.error(i.toString()),this.onError_()}}}class k{constructor(e,n){this.polyfillOptions_=Object.assign(Object.assign({},O),n),this.outputSignals_={dataTerminalReady:!1,requestToSend:!1,break:!1},this.device_=e,this.controlInterface_=B(this.device_,this.polyfillOptions_.usbControlInterfaceClass),this.transferInterface_=B(this.device_,this.polyfillOptions_.usbTransferInterfaceClass),this.inEndpoint_=L(this.transferInterface_,"in"),this.outEndpoint_=L(this.transferInterface_,"out")}get readable(){var e;return!this.readable_&&this.device_.opened&&(this.readable_=new ReadableStream(new G(this.device_,this.inEndpoint_,()=>{this.readable_=null}),{highWaterMark:(e=this.serialOptions_.bufferSize)!==null&&e!==void 0?e:T})),this.readable_}get writable(){var e;return!this.writable_&&this.device_.opened&&(this.writable_=new WritableStream(new J(this.device_,this.outEndpoint_,()=>{this.writable_=null}),new ByteLengthQueuingStrategy({highWaterMark:(e=this.serialOptions_.bufferSize)!==null&&e!==void 0?e:T}))),this.writable_}async open(e){this.serialOptions_=e,this.validateOptions();try{await this.device_.open(),this.device_.configuration===null&&await this.device_.selectConfiguration(1),await this.device_.claimInterface(this.controlInterface_.interfaceNumber),this.controlInterface_!==this.transferInterface_&&await this.device_.claimInterface(this.transferInterface_.interfaceNumber),await this.setLineCoding(),await this.setSignals({dataTerminalReady:!0})}catch(n){throw this.device_.opened&&await this.device_.close(),new Error("Error setting up device: "+n.toString())}}async close(){const e=[];this.readable_&&e.push(this.readable_.cancel()),this.writable_&&e.push(this.writable_.abort()),await Promise.all(e),this.readable_=null,this.writable_=null,this.device_.opened&&(await this.setSignals({dataTerminalReady:!1,requestToSend:!1}),await this.device_.close())}async forget(){return this.device_.forget()}getInfo(){return{usbVendorId:this.device_.vendorId,usbProductId:this.device_.productId}}reconfigure(e){return this.serialOptions_=Object.assign(Object.assign({},this.serialOptions_),e),this.validateOptions(),this.setLineCoding()}async setSignals(e){if(this.outputSignals_=Object.assign(Object.assign({},this.outputSignals_),e),e.dataTerminalReady!==void 0||e.requestToSend!==void 0){const n=(this.outputSignals_.dataTerminalReady?1:0)|(this.outputSignals_.requestToSend?2:0);await this.device_.controlTransferOut({requestType:"class",recipient:"interface",request:j,value:n,index:this.controlInterface_.interfaceNumber})}if(e.break!==void 0){const n=this.outputSignals_.break?65535:0;await this.device_.controlTransferOut({requestType:"class",recipient:"interface",request:V,value:n,index:this.controlInterface_.interfaceNumber})}}validateOptions(){if(!this.isValidBaudRate(this.serialOptions_.baudRate))throw new RangeError("invalid Baud Rate "+this.serialOptions_.baudRate);if(!this.isValidDataBits(this.serialOptions_.dataBits))throw new RangeError("invalid dataBits "+this.serialOptions_.dataBits);if(!this.isValidStopBits(this.serialOptions_.stopBits))throw new RangeError("invalid stopBits "+this.serialOptions_.stopBits);if(!this.isValidParity(this.serialOptions_.parity))throw new RangeError("invalid parity "+this.serialOptions_.parity)}isValidBaudRate(e){return e%1===0}isValidDataBits(e){return typeof e>"u"?!0:H.includes(e)}isValidStopBits(e){return typeof e>"u"?!0:K.includes(e)}isValidParity(e){return typeof e>"u"?!0:Y.includes(e)}async setLineCoding(){var e,n,i;const s=new ArrayBuffer(7),r=new DataView(s);if(r.setUint32(0,this.serialOptions_.baudRate,!0),r.setUint8(4,Z.indexOf((e=this.serialOptions_.stopBits)!==null&&e!==void 0?e:W)),r.setUint8(5,Q.indexOf((n=this.serialOptions_.parity)!==null&&n!==void 0?n:z)),r.setUint8(6,(i=this.serialOptions_.dataBits)!==null&&i!==void 0?i:F),(await this.device_.controlTransferOut({requestType:"class",recipient:"interface",request:q,value:0,index:this.controlInterface_.interfaceNumber},s)).status!="ok")throw new DOMException("NetworkError","Failed to set line coding.")}}class X{async requestPort(e,n){n=Object.assign(Object.assign({},O),n);const i=[];if(e&&e.filters)for(const a of e.filters){const u={classCode:n.usbControlInterfaceClass};a.usbVendorId!==void 0&&(u.vendorId=a.usbVendorId),a.usbProductId!==void 0&&(u.productId=a.usbProductId),i.push(u)}i.length===0&&i.push({classCode:n.usbControlInterfaceClass});const s=await navigator.usb.requestDevice({filters:i});return new k(s,n)}async getPorts(e){e=Object.assign(Object.assign({},O),e);const n=await navigator.usb.getDevices(),i=[];return n.forEach(s=>{try{const r=new k(s,e);i.push(r)}catch{}}),i}}const ee=new X,te="serial"in navigator,se=te?navigator.serial:ee,_=document.getElementById("connect-btn");console.log("connectBtn",_);const S=document.getElementById("disconnect-btn"),h=document.getElementById("clear-log-btn"),f=document.getElementById("save-btn"),m=document.getElementById("status-message"),b=document.getElementById("message-body"),ne=1155,ie=22336,re=115200,ae="S6",oe="O",ce="C",P="\r";let o,l,d,w=!1,g="";const le=new TextEncoder,de=new TextDecoder;let ue=200,v=[];function c(t,e=null){m.textContent=t,console.log("Status:",t),e===!0?(m.className="status-connected",_.disabled=!0,S.disabled=!1,f.disabled=!1,h.disabled=!1):e===!1?(m.className="status-disconnected",_.disabled=!1,S.disabled=!0,f.disabled=v.length===0,h.disabled=v.length===0):(m.className="status-connecting",_.disabled=!0,S.disabled=!0,f.disabled=!0,h.disabled=!0)}function D(t){if(!b)return;const e=b.insertRow(0);e.classList.add("highlight");const n=e.insertCell(),i=e.insertCell(),s=e.insertCell(),r=e.insertCell(),a=e.insertCell(),u=new Date(t.timestamp);for(n.textContent=u.toLocaleTimeString()+"."+String(u.getMilliseconds()).padStart(3,"0"),n.classList.add("timestamp"),i.textContent=t.type.toUpperCase(),s.textContent=t.id||"---",r.textContent=t.dlc!==null?t.dlc:"---",a.textContent=t.data?t.data.join(" "):"---",(t.type==="error"||t.type==="parse_error")&&(e.classList.add("error"),a.textContent=t.raw||t.message||"Error"),setTimeout(()=>e.classList.remove("highlight"),500);b.rows.length>ue;)b.deleteRow(-1)}function x(t){const e={raw:t,type:"unknown",id:null,dlc:null,data:[],timestamp:Date.now()};if(!t||t.length<1)return e;try{const n=t[0],i=t.substring(1);if(n==="t"){e.type="can_std",e.id=i.substring(0,3),e.dlc=parseInt(i.substring(3,4),10);const s=i.substring(4);!isNaN(e.dlc)&&s.length>=e.dlc*2?e.data=s.substring(0,e.dlc*2).match(/.{1,2}/g)||[]:e.data=s.match(/.{1,2}/g)||[]}else if(n==="T"){e.type="can_ext",e.id=i.substring(0,8),e.dlc=parseInt(i.substring(8,9),10);const s=i.substring(9);!isNaN(e.dlc)&&s.length>=e.dlc*2?e.data=s.substring(0,e.dlc*2).match(/.{1,2}/g)||[]:e.data=s.match(/.{1,2}/g)||[]}else n==="r"?(e.type="rtr_std",e.id=i.substring(0,3),e.dlc=parseInt(i.substring(3,4),10),e.data=["RTR"]):n==="R"?(e.type="rtr_ext",e.id=i.substring(0,8),e.dlc=parseInt(i.substring(8,9),10),e.data=["RTR"]):n==="F"?(e.type="status_flags",e.data=[i]):n==="V"?(e.type="version",e.data=[i]):n==="Z"||n==="z"?(e.type="ack",e.data=["OK"]):t==="\x07"?(e.type="error_response",e.data=["BELL (Error)"]):t==="\r"?(e.type="ok_response",e.data=["CR (OK)"]):e.type="other"}catch(n){console.error(`Parse error '${t}': ${n}`),e.type="parse_error",e.message=n.message}return e}function fe(t){const e=new Date(t);return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")} ${String(e.getHours()).padStart(2,"0")}:${String(e.getMinutes()).padStart(2,"0")}:${String(e.getSeconds()).padStart(2,"0")}.${String(e.getMilliseconds()).padStart(3,"0")}`}function pe(){if(v.length===0){alert("No messages to save."),f.disabled=!0;return}const t=`Timestamp,Type,ID,DLC,Data
`,e=v.map(p=>{const $=fe(p.timestamp),N=p.type.toUpperCase(),M=p.id||"",U=p.dlc!==null?p.dlc:"",A=p.data?p.data.join(" "):"",y=E=>String(E).includes(",")?`"${String(E).replace(/"/g,'""')}"`:E;return`${y($)},${y(N)},${y(M)},${y(U)},${y(A)}`}).join(`
`),n=t+e,i=new Blob([n],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a"),r=URL.createObjectURL(i);s.setAttribute("href",r);const a=new Date,u=`can_trace_webusb_${a.getFullYear()}${String(a.getMonth()+1).padStart(2,"0")}${String(a.getDate()).padStart(2,"0")}_${String(a.getHours()).padStart(2,"0")}${String(a.getMinutes()).padStart(2,"0")}${String(a.getSeconds()).padStart(2,"0")}.csv`;s.setAttribute("download",u),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(r)}async function C(t){if(!d){console.error("Writer not available.");return}const e=le.encode(t+P);await d.write(e),console.log("Sent:",t)}async function he(){if(!o||!o.readable){console.error("Port not readable."),w=!1;return}l=o.readable.getReader(),console.log("Read loop started.");try{for(;w;){const{value:t,done:e}=await l.read();if(e){console.log("Reader done.");break}if(t){g+=de.decode(t,{stream:!0});let n=g.split(P);g=n.pop(),n.forEach(i=>{if(i.trim()){const s=x(i.trim());s.type.startsWith("can")||s.type.startsWith("rtr")||s.type==="status_flags"||s.type.includes("error")?D(s):console.log("Device Response:",i.trim())}else console.log("Device Response: CR (OK)")}),g.includes("\x07")&&(console.error("Device Response: BELL (Error)"),D(x("\x07")),g=g.replace("\x07",""))}}}catch(t){console.error("Error in read loop:",t),c(`Read loop error: ${t.message}`,!1)}finally{if(l){try{await l.cancel()}catch(t){console.warn("Error cancelling reader:",t)}l.releaseLock(),l=null,console.log("Reader released.")}}console.log("Read loop finished."),w&&(c("Disconnected (Read loop ended unexpectedly)",!1),await R())}async function ge(){c("Requesting port...",null);try{const t=[{usbVendorId:ne,usbProductId:ie}];o=await se.requestPort({filters:t}),console.log("Port selected:",o),await o.open({baudRate:re}),c("Port open, configuring CAN...",null),d=o.writable.getWriter(),await new Promise(e=>setTimeout(e,100)),await C(""),await new Promise(e=>setTimeout(e,50)),await C(ae),await new Promise(e=>setTimeout(e,50)),await C(oe),await new Promise(e=>setTimeout(e,50)),c("Connected (500 kbit/s)",!0),w=!0,he()}catch(t){if(console.error("Connection failed:",t),c(`Connection failed: ${t.message}`,!1),d)try{d.releaseLock(),d=null}catch{}if(l)try{await l.cancel(),l.releaseLock(),l=null}catch{}if(o&&o.readable)o=null;else if(o)try{await o.close(),o=null}catch{}}}async function R(){if(w=!1,!o){c("Already disconnected",!1);return}if(c("Disconnecting...",null),d)try{await C(ce),await new Promise(t=>setTimeout(t,50))}catch(t){console.warn("Error sending close command:",t)}finally{try{d.releaseLock()}catch(t){console.warn("Error releasing writer lock:",t)}d=null,console.log("Writer released.")}try{await o.close(),console.log("Port closed.")}catch(t){console.error("Error closing port:",t)}finally{o=null,c("Disconnected",!1)}}_.addEventListener("click",ge);S.addEventListener("click",R);h.addEventListener("click",()=>{b&&(b.innerHTML=""),v=[],console.log("Log cleared."),f.disabled=!0,h.disabled=!0});f.addEventListener("click",pe);window.addEventListener("beforeunload",async()=>{device&&await R()});document.addEventListener("DOMContentLoaded",()=>{navigator.usb?(c("Disconnected",!1),f.disabled=!0,h.disabled=!0):(c("WebUSB API not supported.",!1),_.disabled=!0,f.disabled=!0,h.disabled=!0)});
